ARG OPENCV_VERSION=4.5.3
ARG CERES_VERSION=2.1.0

# 비대화형 설치 모드로 설정 (타임존 설정 방지)
ENV DEBIAN_FRONTEND=noninteractive

# OpenCV 및 Python을 위한 모든 의존성 설치
RUN apt-get -y update && \
    apt-get -y install wget unzip cmake libtbb2 gfortran apt-utils pkg-config && \
    apt-get -y install checkinstall qt5-default build-essential libatlas-base-dev libgtk2.0-dev && \
    apt-get -y install libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libjpeg8-dev libpng-dev libtiff5-dev && \
    apt-get -y install libdc1394-22-dev libxine2-dev libv4l-dev libglew-dev libpostproc-dev libeigen3-dev libtbb-dev && \
    apt-get -y install zlib1g-dev libsm6 libxext6 libxrender1 libgoogle-glog-dev ffmpeg python3 python3-pip python3-opencv && \
    # GStreamer 관련 패키지 추가
    apt-get -y install gstreamer1.0-tools gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-ffmpeg && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# OpenCV 다운로드 및 설치
WORKDIR /
RUN wget https://github.com/opencv/opencv/archive/$OPENCV_VERSION.zip -O opencv.zip --progress=bar:force:noscroll && \
    unzip -q opencv.zip && \
    mv /opencv-$OPENCV_VERSION /opencv && \
    rm opencv.zip && \
    wget https://github.com/opencv/opencv_contrib/archive/$OPENCV_VERSION.zip -O opencv_contrib.zip --progress=bar:force:noscroll && \
    unzip -q opencv_contrib.zip && \
    mv /opencv_contrib-$OPENCV_VERSION /opencv_contrib && \
    rm opencv_contrib.zip

# OpenCV 빌드를 위한 준비
RUN mkdir /opencv/build && \
    cd /opencv/build && \
    cmake -D CMAKE_BUILD_TYPE=RELEASE \
      -D BUILD_PYTHON_SUPPORT=ON \
      -D CMAKE_INSTALL_PREFIX=/usr/local \
      -D OPENCV_EXTRA_MODULES_PATH=/opencv_contrib/modules \
      -D OPENCV_ENABLE_NONFREE=ON \
      -D BUILD_EXAMPLES=OFF \
      -D BUILD_PERF_TESTS=OFF \
      -D BUILD_TESTS=OFF \
      -D WITH_IPP=OFF \
      -D WITH_FFMPEG=ON \
      -D WITH_V4L=ON \
      -D WITH_LIBV4L=ON \
      -D WITH_TBB=ON \
      -D WITH_QT=OFF \
      -D WITH_OPENGL=OFF \
      -D CUDA_ARCH_PTX="" \
      -D WITH_CUBLAS=ON \
      -D ENABLE_FAST_MATH=1 \
      -D CUDA_FAST_MATH=1 \
      .. && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Ceres Solver 설치
RUN apt-get update && apt-get install -y git && \
    wget http://ceres-solver.org/ceres-solver-$CERES_VERSION.tar.gz && \
    tar -zxf ceres-solver-$CERES_VERSION.tar.gz && \
    mkdir ceres-bin && cd ceres-bin && \
    cmake ../ceres-solver-$CERES_VERSION -DBUILD_TESTING=OFF -DBUILD_EXAMPLES=OFF -DBUILD_BENCHMARKS=OFF && \
    make -j$(nproc) && \
    make install

# Polynomial 설치
RUN git clone https://github.com/jonathanventura/polynomial.git && \
    mkdir polynomial-build && cd polynomial-build && \
    cmake ../polynomial && \
    make && \
    make install

# 최종 이미지 정리
RUN apt-get clean && rm -rf /var/lib/apt/lists/*
